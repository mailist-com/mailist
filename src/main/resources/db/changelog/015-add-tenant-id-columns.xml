<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="015-add-tenant-id-columns" author="system">
        <!-- Add tenant_id column to all tenant-aware tables -->

        <!-- Step 1: Add columns as nullable first -->
        <addColumn tableName="contacts">
            <column name="tenant_id" type="BIGINT"/>
        </addColumn>

        <addColumn tableName="contact_lists">
            <column name="tenant_id" type="BIGINT"/>
        </addColumn>

        <addColumn tableName="campaigns">
            <column name="tenant_id" type="BIGINT"/>
        </addColumn>

        <addColumn tableName="automation_rules">
            <column name="tenant_id" type="BIGINT"/>
        </addColumn>

        <addColumn tableName="reports">
            <column name="tenant_id" type="BIGINT"/>
        </addColumn>

        <!-- Step 2: Update existing rows with default organization ID (1) -->
        <sql>
            UPDATE contacts SET tenant_id = 1 WHERE tenant_id IS NULL;
            UPDATE contact_lists SET tenant_id = 1 WHERE tenant_id IS NULL;
            UPDATE campaigns SET tenant_id = 1 WHERE tenant_id IS NULL;
            UPDATE automation_rules SET tenant_id = 1 WHERE tenant_id IS NULL;
            UPDATE reports SET tenant_id = 1 WHERE tenant_id IS NULL;
        </sql>

        <!-- Step 3: Now make columns NOT NULL -->
        <addNotNullConstraint tableName="contacts" columnName="tenant_id" columnDataType="BIGINT"/>
        <addNotNullConstraint tableName="contact_lists" columnName="tenant_id" columnDataType="BIGINT"/>
        <addNotNullConstraint tableName="campaigns" columnName="tenant_id" columnDataType="BIGINT"/>
        <addNotNullConstraint tableName="automation_rules" columnName="tenant_id" columnDataType="BIGINT"/>
        <addNotNullConstraint tableName="reports" columnName="tenant_id" columnDataType="BIGINT"/>
        
        <!-- Add foreign key constraints -->
        <addForeignKeyConstraint
            baseTableName="contacts"
            baseColumnNames="tenant_id"
            referencedTableName="organizations"
            referencedColumnNames="id"
            constraintName="fk_contacts_tenant"/>
            
        <addForeignKeyConstraint
            baseTableName="contact_lists"
            baseColumnNames="tenant_id"
            referencedTableName="organizations"
            referencedColumnNames="id"
            constraintName="fk_contact_lists_tenant"/>
            
        <addForeignKeyConstraint
            baseTableName="campaigns"
            baseColumnNames="tenant_id"
            referencedTableName="organizations"
            referencedColumnNames="id"
            constraintName="fk_campaigns_tenant"/>
            
        <addForeignKeyConstraint
            baseTableName="automation_rules"
            baseColumnNames="tenant_id"
            referencedTableName="organizations"
            referencedColumnNames="id"
            constraintName="fk_automation_rules_tenant"/>
            
        <addForeignKeyConstraint
            baseTableName="reports"
            baseColumnNames="tenant_id"
            referencedTableName="organizations"
            referencedColumnNames="id"
            constraintName="fk_reports_tenant"/>
        
        <!-- Add indexes for tenant_id columns for performance -->
        <createIndex tableName="contacts" indexName="idx_contacts_tenant_id">
            <column name="tenant_id"/>
        </createIndex>
        
        <createIndex tableName="contact_lists" indexName="idx_contact_lists_tenant_id">
            <column name="tenant_id"/>
        </createIndex>
        
        <createIndex tableName="campaigns" indexName="idx_campaigns_tenant_id">
            <column name="tenant_id"/>
        </createIndex>
        
        <createIndex tableName="automation_rules" indexName="idx_automation_rules_tenant_id">
            <column name="tenant_id"/>
        </createIndex>
        
        <createIndex tableName="reports" indexName="idx_reports_tenant_id">
            <column name="tenant_id"/>
        </createIndex>
        
        <!-- Update unique constraints to include tenant_id -->
        <dropUniqueConstraint tableName="contacts" constraintName="contacts_organization_id_email_key"/>
        <addUniqueConstraint tableName="contacts" columnNames="tenant_id,email" constraintName="uk_contacts_tenant_email"/>
        
    </changeSet>

</databaseChangeLog>