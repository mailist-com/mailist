<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ==================== SUBSCRIPTION PLANS ==================== -->
    <changeSet id="030-01-create-subscription-plans-table" author="claude">
        <comment>Create subscription_plans table for managing subscription tiers</comment>

        <createTable tableName="subscription_plans">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="name" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="display_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <column name="description" type="TEXT"/>

            <!-- Limits -->
            <column name="contact_limit" type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="email_limit_per_month" type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="user_limit" type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="campaign_limit" type="INTEGER" defaultValue="-1">
                <constraints nullable="false"/>
            </column>

            <column name="automation_limit" type="INTEGER" defaultValue="-1">
                <constraints nullable="false"/>
            </column>

            <!-- Pricing -->
            <column name="base_price_pln" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <column name="price_per_1000_contacts_pln" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Insert default subscription plans -->
        <insert tableName="subscription_plans">
            <column name="id" value="1"/>
            <column name="name" value="FREE"/>
            <column name="display_name" value="Plan Darmowy"/>
            <column name="description" value="Plan startowy dla małych firm"/>
            <column name="contact_limit" value="1000"/>
            <column name="email_limit_per_month" value="9000"/>
            <column name="user_limit" value="1"/>
            <column name="campaign_limit" value="10"/>
            <column name="automation_limit" value="5"/>
            <column name="base_price_pln" value="0.00"/>
            <column name="price_per_1000_contacts_pln" value="0.00"/>
        </insert>

        <insert tableName="subscription_plans">
            <column name="id" value="2"/>
            <column name="name" value="STANDARD"/>
            <column name="display_name" value="Plan Standard"/>
            <column name="description" value="Idealny dla rosnących firm"/>
            <column name="contact_limit" value="-1"/>
            <column name="email_limit_per_month" value="-1"/>
            <column name="user_limit" value="3"/>
            <column name="campaign_limit" value="-1"/>
            <column name="automation_limit" value="-1"/>
            <column name="base_price_pln" value="49.00"/>
            <column name="price_per_1000_contacts_pln" value="49.00"/>
        </insert>

        <insert tableName="subscription_plans">
            <column name="id" value="3"/>
            <column name="name" value="PRO"/>
            <column name="display_name" value="Plan Pro"/>
            <column name="description" value="Pełna funkcjonalność bez limitów"/>
            <column name="contact_limit" value="-1"/>
            <column name="email_limit_per_month" value="-1"/>
            <column name="user_limit" value="-1"/>
            <column name="campaign_limit" value="-1"/>
            <column name="automation_limit" value="-1"/>
            <column name="base_price_pln" value="99.00"/>
            <column name="price_per_1000_contacts_pln" value="99.00"/>
        </insert>

        <createIndex tableName="subscription_plans" indexName="idx_subscription_plans_name">
            <column name="name"/>
        </createIndex>
    </changeSet>

    <!-- ==================== ORGANIZATION SUBSCRIPTIONS ==================== -->
    <changeSet id="030-02-create-organization-subscriptions-table" author="claude">
        <comment>Create organization_subscriptions table to track active subscriptions</comment>

        <createTable tableName="organization_subscriptions">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="tenant_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="subscription_plan_id" type="BIGINT">
                <constraints nullable="false"
                             foreignKeyName="fk_org_subscription_plan"
                             referencedTableName="subscription_plans"
                             referencedColumnNames="id"/>
            </column>

            <!-- Selected contact tier (for dynamic pricing) -->
            <column name="contact_tier" type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <!-- Calculated price -->
            <column name="price_pln" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <!-- Subscription status -->
            <column name="status" type="VARCHAR(20)" defaultValue="ACTIVE">
                <constraints nullable="false"/>
            </column>

            <!-- Billing cycle -->
            <column name="billing_cycle" type="VARCHAR(20)" defaultValue="MONTHLY">
                <constraints nullable="false"/>
            </column>

            <!-- Dates -->
            <column name="start_date" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="end_date" type="TIMESTAMP"/>

            <column name="next_billing_date" type="TIMESTAMP"/>

            <column name="cancelled_at" type="TIMESTAMP"/>

            <column name="cancellation_reason" type="TEXT"/>

            <!-- Payment provider data -->
            <column name="payment_provider" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="external_subscription_id" type="VARCHAR(255)"/>

            <column name="external_customer_id" type="VARCHAR(255)"/>

            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="organization_subscriptions"
                                 baseColumnNames="tenant_id"
                                 constraintName="fk_org_subscription_tenant"
                                 referencedTableName="organizations"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <createIndex tableName="organization_subscriptions" indexName="idx_org_subscriptions_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <createIndex tableName="organization_subscriptions" indexName="idx_org_subscriptions_status">
            <column name="status"/>
        </createIndex>

        <createIndex tableName="organization_subscriptions" indexName="idx_org_subscriptions_external_id">
            <column name="external_subscription_id"/>
        </createIndex>
    </changeSet>

    <!-- ==================== PAYMENTS ==================== -->
    <changeSet id="030-03-create-payments-table" author="claude">
        <comment>Create payments table for tracking all payment transactions</comment>

        <createTable tableName="payments">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="tenant_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="subscription_id" type="BIGINT">
                <constraints nullable="true"
                             foreignKeyName="fk_payment_subscription"
                             referencedTableName="organization_subscriptions"
                             referencedColumnNames="id"/>
            </column>

            <column name="amount_pln" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <column name="currency" type="VARCHAR(3)" defaultValue="PLN">
                <constraints nullable="false"/>
            </column>

            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>

            <column name="payment_method" type="VARCHAR(50)"/>

            <column name="payment_provider" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="external_payment_id" type="VARCHAR(255)"/>

            <column name="external_invoice_id" type="VARCHAR(255)"/>

            <column name="description" type="TEXT"/>

            <column name="metadata" type="TEXT"/>

            <column name="paid_at" type="TIMESTAMP"/>

            <column name="failed_at" type="TIMESTAMP"/>

            <column name="failure_reason" type="TEXT"/>

            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="payments"
                                 baseColumnNames="tenant_id"
                                 constraintName="fk_payment_tenant"
                                 referencedTableName="organizations"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <createIndex tableName="payments" indexName="idx_payments_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <createIndex tableName="payments" indexName="idx_payments_status">
            <column name="status"/>
        </createIndex>

        <createIndex tableName="payments" indexName="idx_payments_external_id">
            <column name="external_payment_id"/>
        </createIndex>
    </changeSet>

    <!-- ==================== INVOICES ==================== -->
    <changeSet id="030-04-create-invoices-table" author="claude">
        <comment>Create invoices table for Fakturownia integration</comment>

        <createTable tableName="invoices">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="tenant_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="payment_id" type="BIGINT">
                <constraints nullable="true"
                             foreignKeyName="fk_invoice_payment"
                             referencedTableName="payments"
                             referencedColumnNames="id"/>
            </column>

            <column name="subscription_id" type="BIGINT">
                <constraints nullable="true"
                             foreignKeyName="fk_invoice_subscription"
                             referencedTableName="organization_subscriptions"
                             referencedColumnNames="id"/>
            </column>

            <column name="invoice_number" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>

            <column name="external_invoice_id" type="VARCHAR(255)"/>

            <column name="amount_pln" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <column name="tax_amount_pln" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <column name="total_amount_pln" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>

            <column name="currency" type="VARCHAR(3)" defaultValue="PLN">
                <constraints nullable="false"/>
            </column>

            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>

            <column name="invoice_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="invoice_date" type="DATE">
                <constraints nullable="false"/>
            </column>

            <column name="due_date" type="DATE">
                <constraints nullable="false"/>
            </column>

            <column name="paid_date" type="DATE"/>

            <column name="pdf_url" type="TEXT"/>

            <column name="fakturownia_url" type="TEXT"/>

            <column name="description" type="TEXT"/>

            <column name="buyer_name" type="VARCHAR(255)"/>

            <column name="buyer_email" type="VARCHAR(255)"/>

            <column name="buyer_tax_id" type="VARCHAR(50)"/>

            <column name="buyer_address" type="TEXT"/>

            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="invoices"
                                 baseColumnNames="tenant_id"
                                 constraintName="fk_invoice_tenant"
                                 referencedTableName="organizations"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <createIndex tableName="invoices" indexName="idx_invoices_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <createIndex tableName="invoices" indexName="idx_invoices_status">
            <column name="status"/>
        </createIndex>

        <createIndex tableName="invoices" indexName="idx_invoices_number">
            <column name="invoice_number"/>
        </createIndex>

        <createIndex tableName="invoices" indexName="idx_invoices_external_id">
            <column name="external_invoice_id"/>
        </createIndex>
    </changeSet>

    <!-- ==================== USAGE TRACKING ==================== -->
    <changeSet id="030-05-create-usage-tracking-table" author="claude">
        <comment>Create usage_tracking table for monitoring subscription limits</comment>

        <createTable tableName="usage_tracking">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="tenant_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="tracking_period" type="VARCHAR(7)">
                <constraints nullable="false"/>
            </column>

            <column name="contact_count" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>

            <column name="email_sent_count" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>

            <column name="campaign_count" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>

            <column name="automation_count" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>

            <column name="user_count" type="INTEGER" defaultValue="0">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>

            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="usage_tracking"
                                 baseColumnNames="tenant_id"
                                 constraintName="fk_usage_tracking_tenant"
                                 referencedTableName="organizations"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <addUniqueConstraint tableName="usage_tracking"
                             columnNames="tenant_id, tracking_period"
                             constraintName="uk_usage_tracking_tenant_period"/>

        <createIndex tableName="usage_tracking" indexName="idx_usage_tracking_tenant_period">
            <column name="tenant_id"/>
            <column name="tracking_period"/>
        </createIndex>
    </changeSet>

    <!-- ==================== SUBSCRIPTION NOTIFICATIONS ==================== -->
    <changeSet id="030-06-create-subscription-notifications-table" author="claude">
        <comment>Create subscription_notifications table for limit warnings and alerts</comment>

        <createTable tableName="subscription_notifications">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="tenant_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="notification_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="resource_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>

            <column name="threshold_percentage" type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="current_usage" type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="limit_value" type="INTEGER">
                <constraints nullable="false"/>
            </column>

            <column name="is_sent" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>

            <column name="sent_at" type="TIMESTAMP"/>

            <column name="message" type="TEXT"/>

            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="subscription_notifications"
                                 baseColumnNames="tenant_id"
                                 constraintName="fk_subscription_notification_tenant"
                                 referencedTableName="organizations"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>

        <createIndex tableName="subscription_notifications" indexName="idx_subscription_notifications_tenant">
            <column name="tenant_id"/>
        </createIndex>

        <createIndex tableName="subscription_notifications" indexName="idx_subscription_notifications_type">
            <column name="notification_type"/>
        </createIndex>

        <createIndex tableName="subscription_notifications" indexName="idx_subscription_notifications_sent">
            <column name="is_sent"/>
        </createIndex>
    </changeSet>

    <!-- ==================== UPDATE ORGANIZATIONS TABLE ==================== -->
    <changeSet id="030-07-update-organizations-table" author="claude">
        <comment>Update organizations table to add email limits and user limits</comment>

        <addColumn tableName="organizations">
            <column name="email_limit_per_month" type="INTEGER" defaultValue="9000">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="organizations">
            <column name="user_limit" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addColumn tableName="organizations">
            <column name="current_subscription_id" type="BIGINT">
                <constraints nullable="true"
                             foreignKeyName="fk_org_current_subscription"
                             referencedTableName="organization_subscriptions"
                             referencedColumnNames="id"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- ==================== UPDATE ORGANIZATION PLAN ENUM ==================== -->
    <changeSet id="030-08-update-organization-plan-enum" author="claude">
        <comment>Update organization plan enum to use new subscription tiers (FREE, STANDARD, PRO)</comment>

        <!-- Update existing PRO plans to STANDARD -->
        <sql>
            UPDATE organizations
            SET plan = 'STANDARD'
            WHERE plan = 'PROFESSIONAL';
        </sql>

        <!-- Update existing ENTERPRISE plans to PRO -->
        <sql>
            UPDATE organizations
            SET plan = 'PRO'
            WHERE plan = 'ENTERPRISE';
        </sql>

        <!-- Add check constraint for new plan values -->
        <sql>
            ALTER TABLE organizations
            DROP CONSTRAINT IF EXISTS organizations_plan_check;
        </sql>

        <sql>
            ALTER TABLE organizations
            ADD CONSTRAINT organizations_plan_check
            CHECK (plan IN ('FREE', 'STANDARD', 'PRO'));
        </sql>
    </changeSet>

</databaseChangeLog>
